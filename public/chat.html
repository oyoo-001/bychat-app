<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bychat</title>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
 <style>
        /* --- Global Resets & Base Styles --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            position: relative;
        }

        /* --- Header Styles (Fixed at top) --- */
        header {
            background: #1f2c34;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 1.4em;
            color: #e0e0e0;
        }

        .header-icons {
            display: flex;
            gap: 20px;
        }

        .header-icons .icon-btn {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s;
        }

        .header-icons .icon-btn:hover {
            color: #4CAF50; /* A nice green for hover */
        }

        /* --- Main Chat Container --- */
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* To manage inner scroll */
            position: relative;
            background-color: #0d1418; /* Dark background for chat area */
        }

        /* --- Chat History/Messages Area --- */
        #chat-history {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* Make messages scrollable */
            display: flex;
            flex-direction: column; /* Arrange messages vertically */
            gap: 10px; /* Space between messages */
            scroll-behavior: smooth; /* Smooth scrolling to new messages */
        }

        /* --- Message Row Styling (common) --- */
        .message-row {
            display: flex;
            width: 100%;
        }

        /* --- Individual Message Bubble --- */
        .message-bubble {
            max-width: 70%;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.95em;
            word-wrap: break-word; /* Ensure long words wrap */
            position: relative;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        .message-bubble .message-sender {
            display: block;
            font-size: 0.75em;
            color: #8899a6; /* Lighter grey for sender name */
            margin-bottom: 3px;
            font-weight: bold;
        }

        .message-bubble .message-timestamp {
            display: block;
            font-size: 0.7em;
            color: #8899a6;
            text-align: right;
            margin-top: 5px;
            float: right; /* Keeps it right-aligned within the bubble */
            clear: both; /* Ensures it's below text/sender */
        }

        .message-bubble .message-content-text { /* Added class for text */
            display: block; /* Ensures it takes its own line if needed */
            margin-top: 5px; /* Space from sender name */
        }

        /* --- My Messages (Sent) --- */
        .my-message-row {
            justify-content: flex-end; /* Align to right */
        }

        .my-message-bubble {
            background-color: #056162; /* A WhatsApp-like green-blue */
            color: #e0e0e0;
            border-bottom-right-radius: 2px; /* Pointy corner */
        }

        /* --- Other Messages (Received) --- */
        .other-message-row {
            justify-content: flex-start; /* Align to left */
        }

        .other-message-bubble {
            background-color: #262D31; /* Darker grey for received messages */
            color: #e0e0e0;
            border-bottom-left-radius: 2px; /* Pointy corner */
        }

        /* --- System Messages --- */
        .system-message-row {
            justify-content: center;
        }

        .system-message-bubble {
            background-color: #3e444b;
            color: #cccccc;
            font-style: italic;
            text-align: center;
            max-width: 80%;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* --- Chat Input Area --- */
        #chat-input-area {
            display: flex;
            padding: 10px 20px;
            background: #1f2c34;
            border-top: 1px solid #262D31;
            align-items: center;
            gap: 10px;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid #3e444b;
            background-color: #262D31;
            color: #e0e0e0;
            font-size: 1em;
            outline: none;
            resize: none; /* Prevent manual resizing */
            overflow: hidden; /* Hide scrollbar initially */
            min-height: 40px; /* Minimum height for input */
            max-height: 120px; /* Max height before scroll */
            line-height: 1.5; /* Good line height */
        }
        #message-input::placeholder {
            color: #8899a6;
        }

        #send-button {
            background-color: #056162;
            color: #e0e0e0;
            border: none;
            border-radius: 50%; /* Make it round */
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #send-button:hover {
            background-color: #044a4b;
        }

        /* --- User List Overlay --- */
        #user-list-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
        }

        #user-list-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .user-list-modal {
            background: #1f2c34;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
        }

        .user-list-modal h2 {
            margin-top: 0;
            color: #e0e0e0;
            border-bottom: 1px solid #3e444b;
            padding-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .user-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 10px; /* For scrollbar */
        }

        .user-list-item {
            padding: 10px 0;
            border-bottom: 1px solid #262D31;
            color: #e0e0e0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-list-item:last-child {
            border-bottom: none;
        }
        .user-list-item i {
            color: #4CAF50; /* Online indicator */
        }

        .close-modal-btn {
            background-color: #056162;
            color: #e0e0e0;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            margin-top: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            align-self: center;
        }
        .close-modal-btn:hover {
            background-color: #044a4b;
        }

        /* --- Login/Username Prompt Overlay --- */
        #username-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .username-prompt-modal {
            background: #1f2c34;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }

        .username-prompt-modal h2 {
            margin-top: 0;
            color: #e0e0e0;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .username-prompt-modal input[type="text"] {
            width: calc(100% - 20px);
            padding: 12px 10px;
            margin-bottom: 20px;
            border: 1px solid #3e444b;
            border-radius: 5px;
            background-color: #262D31;
            color: #e0e0e0;
            font-size: 1em;
            outline: none;
        }

        .username-prompt-modal button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .username-prompt-modal button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <header>
        <h1>Bychat</h1>
        <div class="header-icons">
            <button id="show-users-btn" class="icon-btn"><i class="fas fa-users"></i></button>
            <button id="bg-settings-btn" class="icon-btn"><i class="fas fa-image"></i></button>
            <button id="logout-btn" class="icon-btn"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <div id="chat-container">
        <div id="chat-history">
            </div>

        <div id="chat-input-area">
            <textarea id="message-input" placeholder="Type a message..."></textarea>
            <button id="send-button"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="user-list-overlay">
        <div class="user-list-modal">
            <h2>Online Users</h2>
            <div class="user-list" id="online-users-list">
                </div>
            <button class="close-modal-btn">Close</button>
        </div>
    </div>

    <div id="username-prompt-overlay">
        <div class="username-prompt-modal">
            <h2>Choose a Username</h2>
            <input type="text" id="username-input" placeholder="Enter your username">
            <button id="join-chat-btn">Join Chat</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const showUsersBtn = document.getElementById('show-users-btn');
        const userListOverlay = document.getElementById('user-list-overlay');
        const onlineUsersList = document.getElementById('online-users-list');
        const closeModalBtn = userListOverlay.querySelector('.close-modal-btn');
        const usernamePromptOverlay = document.getElementById('username-prompt-overlay');
        const usernameInput = document.getElementById('username-input');
        const joinChatBtn = document.getElementById('join-chat-btn');
        const bgSettingsBtn = document.getElementById('bg-settings-btn');
        const logoutBtn = document.getElementById('logout-btn');


        let ws;
        let currentUsername = localStorage.getItem('chatUsername'); // Try to get username from local storage

        // --- WebSocket Connection ---
        function connectWebSocket() {
            if (ws) {
                ws.close(); // Close existing connection if any
            }
            // Use wss:// for secure WebSocket if your server supports it, or ws:// for insecure
            ws = new WebSocket('ws://localhost:8080'); // Replace with your WebSocket server address

            ws.onopen = () => {
                console.log('WebSocket connected');
                // Send username upon connection
                if (currentUsername) {
                    ws.send(JSON.stringify({ type: 'login', username: currentUsername }));
                } else {
                    showUsernamePrompt(); // Prompt if no username
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);

                switch (data.type) {
                    case 'chatMessage':
                        // Ensure 'message' property holds the content
                        appendMessage(data.sender, data.message, false, data.timestamp);
                        break;
                    case 'systemMessage':
                        appendMessage('System', data.message, true);
                        break;
                    case 'userList':
                        updateUserList(data.users);
                        break;
                    case 'chatHistory':
                        data.history.forEach(msg => {
                            // Ensure 'message' property holds the content
                            appendMessage(msg.sender, msg.message, false, msg.timestamp);
                        });
                        break;
                    case 'loggedIn':
                        currentUsername = data.username;
                        localStorage.setItem('chatUsername', currentUsername); // Save username
                        usernamePromptOverlay.style.display = 'none'; // Hide prompt
                        appendMessage('System', `Welcome, ${currentUsername}!`, true);
                        break;
                    case 'loginFailed':
                        alert(`Login failed: ${data.message}`);
                        showUsernamePrompt(); // Re-prompt on failure
                        break;
                    case 'chat_background_image_url':
                        applyChatBackgroundImage(data.chat_background_image_url);
                        break;
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected. Attempting to reconnect...');
                appendMessage('System', 'Disconnected. Reconnecting...', true);
                setTimeout(connectWebSocket, 3000); // Reconnect after 3 seconds
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                appendMessage('System', 'Connection error. See console.', true);
                ws.close(); // Attempt to close and trigger onclose for reconnect
            };
        }

        // --- Message Appending ---
        function appendMessage(sender, message, isSystem = false, timestamp = null) {
            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row');

            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');

            if (isSystem) {
                messageRow.classList.add('system-message-row');
                messageBubble.classList.add('system-message-bubble');
                messageBubble.textContent = message;
            } else {
                if (sender === currentUsername) {
                    messageRow.classList.add('my-message-row');
                    messageBubble.classList.add('my-message-bubble');
                    // For 'my' messages, just append the message text directly to the bubble
                    const messageTextNode = document.createTextNode(message);
                    messageBubble.appendChild(messageTextNode);
                } else {
                    messageRow.classList.add('other-message-row');
                    messageBubble.classList.add('other-message-bubble');
                    const senderSpan = document.createElement('span');
                    senderSpan.classList.add('message-sender');
                    senderSpan.textContent = sender;
                    messageBubble.prepend(senderSpan);

                    // Append the actual message content after the sender name for 'other' messages
                    const messageTextNode = document.createTextNode(message);
                    messageBubble.appendChild(messageTextNode);
                }

                if (timestamp) {
                    const timestampSpan = document.createElement('span');
                    timestampSpan.classList.add('message-timestamp');
                    timestampSpan.textContent = formatTimestamp(timestamp);
                    messageBubble.appendChild(timestampSpan);
                }
            }
            messageRow.appendChild(messageBubble);
            chatContainer.appendChild(messageRow);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function formatTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // --- Event Listeners ---
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'chatMessage', message: message }));
                messageInput.value = ''; // Clear input
                messageInput.style.height = 'auto'; // Reset textarea height
            }
        }

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto'; // Reset height
            messageInput.style.height = messageInput.scrollHeight + 'px'; // Set to scroll height
        });

        showUsersBtn.addEventListener('click', () => {
            userListOverlay.classList.add('active');
            // Request updated user list from server if needed
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'requestUserList' }));
            }
        });

        closeModalBtn.addEventListener('click', () => {
            userListOverlay.classList.remove('active');
        });

        // Close modal if clicking outside
        userListOverlay.addEventListener('click', (e) => {
            if (e.target === userListOverlay) {
                userListOverlay.classList.remove('active');
            }
        });

        function updateUserList(users) {
            onlineUsersList.innerHTML = ''; // Clear existing list
            if (users && users.length > 0) {
                users.forEach(user => {
                    const listItem = document.createElement('div');
                    listItem.classList.add('user-list-item');
                    listItem.innerHTML = `<i class="fas fa-circle"></i> ${user}`;
                    onlineUsersList.appendChild(listItem);
                });
            } else {
                onlineUsersList.innerHTML = '<div style="text-align: center; color: #8899a6;">No other users online.</div>';
            }
        }

        function showUsernamePrompt() {
            usernamePromptOverlay.style.display = 'flex';
            usernameInput.focus();
        }

        joinChatBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                currentUsername = username;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'login', username: currentUsername }));
                } else {
                    // If WS not open yet, connect and it will send login
                    connectWebSocket();
                }
            } else {
                alert('Please enter a username.');
            }
        });

        // Handle background image settings
        bgSettingsBtn.addEventListener('click', () => {
            const imageUrl = prompt("Enter image URL for chat background (leave blank to clear):");
            if (imageUrl !== null) { // User didn't cancel
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'set_chat_background', url: imageUrl }));
                }
            }
        });

        function applyChatBackgroundImage(imageUrl) {
            const chatBox = document.getElementById('chat-container'); // Apply to chat-container or chat-history
            if (chatBox) {
                if (imageUrl) {
                    chatBox.style.backgroundImage = `url('${imageUrl}')`;
                    chatBox.style.backgroundSize = 'cover';
                    chatBox.style.backgroundPosition = 'center';
                    chatBox.style.backgroundAttachment = 'fixed';
                    console.log(`Applied background image: ${imageUrl}`);
                } else {
                    chatBox.style.backgroundImage = '';
                    console.log('Cleared chat background image.');
                }
            }
        }

        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            if (currentUsername && confirm('Are you sure you want to log out?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'logout', username: currentUsername }));
                }
                localStorage.removeItem('chatUsername'); // Clear username from storage
                currentUsername = null;
                appendMessage('System', 'You have been logged out.', true);
                // Optionally redirect to a login page or show username prompt
                showUsernamePrompt();
            }
        });


        // Initial connection check
        if (!currentUsername) {
            showUsernamePrompt();
        } else {
            connectWebSocket(); // Connect automatically if username exists
        }
    </script>
</body>
</html>